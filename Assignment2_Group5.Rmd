---
title: "A2_Group5"
author: "Merel Das (6600034), Mirre Dona (6156630), Lukas Stemerdink (6217265)"
date: "2023-11-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries
```{r}
library(ISLR) 
library(tidyverse) 
library(readr) # For data import
library(dplyr)
library(magrittr) # For pipes
library(mice) # For missing data
library(ggplot2) # For plotting
library(psych)
library(reshape2)

library(randomForest) # For random forest
library(rpart) # For decision tree
library(rpart.plot) # For plotting decision tree
library(caret) # rf and boosting

library(gridExtra) # For assumption checking of LDA
library(caret) # For confusion matrix

# install.packages("Metrics")
library(Metrics) # For accuracy metric

```

# Import dataset
```{r}
sleepdata <- read.csv('data/Sleep_health_and_lifestyle_dataset.csv')
head(sleepdata)
```

# Description of the data
The Sleep Health and Lifestyle Dataset, here called sleepdata, consists of 400 rows and 13 columns. The dataset consists of sleep-related data. A lot of variables are presented, including gender, age, occupation, sleep duration, quality of sleep, physical activity levels, stress levels, BMI category, blood pressure, heart rate, daily steps, and, if it is the case, the sleep disorders. This dataset offers the opportunity to gain insights into whether sleep factors and lifestyle factors are related.

The following variables are included in the dataset:
* **Person ID**: An identifier for each individual in the dataset (stored as integer).
* **Gender**: [Male/Female] (stored as object).
* **Age**: The age of the person in years (stored as integer).
* **Occupation**: The occupation or profession of the person (stored as object).
* **Sleep Duration**: The number of hours the person sleeps per day (stored as float).
* **Quality of Sleep**: [1-10] A subjective rating of the quality of sleep, ranging from 1 to 10 (stored as integer).
* **Physical Activity Level**: The number of minutes the person engages in physical activity daily (stored as integer of minutes/day).
* **Stress Level** [1-10]: A subjective rating of the stress level experienced by the person, ranging from 1 to 10 (stored as integer).
* **BMI Category**: The BMI category of the person (e.g., Underweight, Normal, Overweight, stored as object).
* **Blood Pressure** (systolic/diastolic): The blood pressure measurement of the person, indicated as systolic pressure over diastolic pressure (stored as object).
* **Heart Rate** (bpm): The resting heart rate of the person in beats per minute (stored as integer).
* **Daily Steps**: The number of steps the person takes per day (stored as integer).
* **Sleep Disorder**: The presence or absence of a sleep disorder in the person (None, Insomnia, Sleep Apnea, stored as object).

To download the dataset, click [here](https://www.kaggle.com/code/jillanisofttech/sleep-health-and-lifestyle-predication-with-94-ac).

With this dataset, we aim to predict a person's sleep quality. We chose this response variable as we think it is valuable information for a person. Sleep quality is important for your health and can affect mental-health issues. It also influences how you feel during the day, which affects the activities you undertake and how well you do them.

# Data cleaning
Before we begin, the data should be cleaned for proper use.

## Missing data
```{r}
md.pattern(sleepdata, rotate.names = TRUE)
```
There is no missing data in this dataset!

## Transform variable types
Let's convert the variables to the right type for exploration and prediction later on. We chose to transform the sleep quality (a scale from 10 - 10) to a factor, as we have found in literature that for ratings with a narrow range, classification techniques often work better than regression. [1](https://aclanthology.org/W10-1205.pdf)[2](https://towardsdatascience.com/1-to-5-star-ratings-classification-or-regression-b0462708a4df). Blood.Pressure is split into Systolic (pressure) and Diastolic (pressure), both are then compared to ideal/high/low pressure and labeled as such [3](https://www.nhs.uk/common-health-questions/lifestyle/what-is-blood-pressure/). 
```{r}
# Check how many unique values of occupation, to see if it makes sense to convert to factor, or if there are too many unique values
unique(sleepdata$Occupation)
#The amount of values for the other chr variables were inspected in the R environment

# Blood.Pressure is split, converted, and compared
# All variables are changed to factor, as downloading a .csv changes all properties
sleepdata %<>% 
  mutate(Gender   = as.factor(Gender),
         Occupation = as.factor(Occupation),
         BMI.Category = as.factor(BMI.Category),
         Sleep.Disorder = as.factor(Sleep.Disorder),
         Sleep.Disorder = as.factor(Sleep.Disorder)) %>% 
  separate_wider_delim(cols = Blood.Pressure, delim = "/", names = c("Systolic", "Diastolic")) %>% 
  mutate(Blood.Reading = ifelse(
    test = Systolic >= 130 & Diastolic >= 90, yes = "High", no = ifelse(
      test = Systolic <= 90 & Diastolic <= 60, yes = "Low", no = "Ideal"
    )))
```

## Select variables
For our analysis and prediction we do not need the person identifier of each case, so we remove this variable.
```{r}
sleepdata %<>% select(-Person.ID) # Remove Person.ID from sleepdata
```

## Outlier removal
We checked for potential outliers based on the IQR criterion. For this, we used boxplot stats per numerical value, and looked how many outliers it produced. 

```{r}
# Check the outliers per variable:
boxplot.stats(sleepdata$Sleep.Duration)$out 
boxplot.stats(sleepdata$Quality.of.Sleep)$out
boxplot.stats(sleepdata$Physical.Activity.Level)$out
boxplot.stats(sleepdata$Stress.Level)$out
boxplot.stats(sleepdata$Heart.Rate)$out
boxplot.stats(sleepdata$Daily.Steps)$out

out <- boxplot.stats(sleepdata$Heart.Rate)$out # Save the outliers of Heart.Rate in variable out
out_ind <- which(sleepdata$Heart.Rate %in% c(out)) # Find the indices of the outliers in the dataset
sleepdata[out_ind, ] %>% 
  select(Heart.Rate, BMI.Category, Sleep.Disorder) # Show the outliers in the dataset
```
As can be seen, only the Heart.Rate variable contains outliers; people with a much higher than average heart rate during sleep. When we look at the entries, we see that all these people have a sleep disorder, and that almost all of them are overweight or obese. Because of this, we assume that these are "expected" outliers, and keep them in the dataset. 

# Exploratory data analysis

To explore the data, we take a look at different factors we have deemed as important: Quality of sleep, sleep duration, and BMI category

```{r}
# Create a boxplot of the sleep quality per sleep duration
plot_sleepdata2 <- sleepdata %>% mutate(
  Quality.of.Sleep = as.factor(Quality.of.Sleep)
) %>% 
  ggplot(aes(x=Quality.of.Sleep, y=Sleep.Duration)) + 
  geom_boxplot(fill = "lightblue") + 
  theme_minimal() +
  labs(title="Sleep quality compared to sleep duration", x="Sleep quality", y="Sleep duration")
plot_sleepdata2
```

As can be seen in the box plot above, generally, the sleep quality increases as sleep duration increases. 
```{r}
ggplot(sleepdata, aes(x = Gender, y = Quality.of.Sleep)) +
  geom_boxplot(fill = "lightblue") +
  theme_minimal() +
  labs(title = "Sleep Quality by Gender", y = "Quality of Sleep")
```

Moreover, women seem to have a higher quality of sleep on average compared to men. 

```{r}
sleepdata %>% 
  group_by(Occupation) %>%
  summarise( 
    median = median(Sleep.Duration),
    min = min(Sleep.Duration),
    max = max(Sleep.Duration),
    mad = mad(Sleep.Duration) # Adding median absolute deviation 
  )
```

Then, looking at the median, min, max, and median absolute deviation sleep duration per occupation, it can be seen that Sales Representatives sleep the least on average, followed by Scientist. Though the variation is not very strong per occupation, there is some variance. 

```{r}
sleepdata %>% 
  ggplot(aes(x = BMI.Category, y = Quality.of.Sleep)) + 
  scale_x_discrete(limits = c("Normal", "Normal Weight", "Overweight", "Obese")) +
  geom_boxplot(fill = "lightblue") + 
  theme_minimal() + 
  labs(title = "Sleep Quality per BMI category", x = "BMI category", y = "Quality of Sleep")
```

Lastly, looking at how the BMI category impacts the quality of sleep, people with lower weight seem to sleep better than heavier people. 

# Prediction model
As described above, the response variable we chose to predict is quality of sleep. This is a (transformed) categorical variable with possible values 1 through 10.

## Simple model selection
As a model for this prediction problem we considered decision trees (including bagging, boosting, and random forest), support vector machines, LDA, and K-nearest neighbors, since these are the methods we studied in the course for multi-class classification.

We decided not to go with support vector machines as it is most effective when there is a clear margin of separation between classes, and we don't think this will be the case for this dataset. Although we transformed the response variable to a factor, we know there is actually an ordinal structure in the variable. The ratings are also subjective, so it could for example be that some people rated their sleep quality a 6, while others would rate it 5 or 7. This means the classes are probably overlapping.

This is also the reason why we do not think KNN will be a good method, as this method works best for well-defined clusters.

LDA is an effective method for multi-class identification, but assumes that the features are normally distributed within each class and that the covariance matrices of different classes are equal. As can be seen below, the covariance matrices are not equal in the case of our data, and categorical variables are not continuous and therefore cannot be normally distributed, so we do not use this method.

```{r, warning=FALSE}
plot <- list()
box_variables <- c("Age", "Sleep.Duration", "Physical.Activity.Level", "Stress.Level", "Heart.Rate", "Daily.Steps")
for(i in box_variables) {
    plot[[i]] <- ggplot(sleepdata, 
                        aes_string(x = "Quality.of.Sleep", 
                                   y = i, 
                                   col = "Quality.of.Sleep", 
                                   fill = "Quality.of.Sleep")) + 
    geom_boxplot(fill = "lightblue") + 
    theme(legend.position = "none") + 
    scale_color_manual(values = c("blue", "red")) +
    scale_fill_manual(values = c("blue", "red")) +
      theme_minimal()
}
do.call(grid.arrange, c(plot, nrow = 1))
```

We chose to use decision trees as classification models as they are robust, handle non-linear relationships well, and can capture complex interactions in the data. They is also good at finding the most informative predictors in the set without having to specify them. As a first model, we simply train one decision tree. 

### Train, dev, test
First we split the data in training, and test data
```{r}
set.seed(123)

sleepdatatree <- sleepdata %>% 
  select(-Diastolic, -Systolic)

# Create a training set and a test set
train <- sample(1:nrow(sleepdatatree), 0.75*nrow(sleepdatatree)) # 75% of the rows for the training set
train_data <- sleepdatatree[train,]
test_data <- sleepdatatree[-train,] # Use the other 25% of the rows for the test set

```

### Train model

```{r}
# Train the decision tree model using the training data.
tree_mod <- rpart(Quality.of.Sleep ~ ., data = train_data, method = "class") #method = "class" because we are predicting a categorical variable

# Plot tree
# yesno = 2: adds yes/no at each level.
# type = 0 : shows the node numbers only.
# extra = 0: no additional information.
rpart.plot(tree_mod, yesno=2) 
```
### Performance evaluation
```{r}
# Class prediction
class_predicted <- predict(tree_mod,
                           newdata = test_data,
                           type = "class")
class_predicted
```
```{r}
# Generate confusion matrix for the test data
confusionMatrix(class_predicted, reference = test_data$Quality.of.Sleep)

```
```{r}
# Model accuracy
accuracy(actual = test_data$Quality.of.Sleep, predicted = class_predicted)

```


# Complex model selection
To improve upon our simple model, we tried random forest and boosting. As ...
## Random forest
```{r}
cvcontrol <- trainControl(method = "repeatedcv", #cross validation
                          number = 10,
                          allowParallel = TRUE)
rf_train <- train(Quality.of.Sleep ~ .,
                  data = train_data, 
                  method = 'rf',
                  trControl = cvcontrol,
                  importance = TRUE)

rf_test  <- predict(rf_train, newdata = test_data)
rf_test
```

As the structure information of the trees is lost when averaging multiple trees, we can inspect which predictors were most informative by plotting the variable importance. 
```{r}
rf_train %>%
  varImp %>%
  plot

```

## Boosting
```{r}
gbm_train <- train(Quality.of.Sleep ~ .,
                   data = sleepdata,
                   method = "gbm",
                   verbose = F, 
                   trControl = cvcontrol) #print bag_train, rf_train, gbm_train models to see accuracy

summary(gbm_train) #var importance plot

gbm_test <- predict(gbm_train, newdata = test)
```


### Performance evaluation
accuracy? roc/auc? -> see week 6
```{r}
confusionMatrix(preds, labels)
```






