---
title: "A2_Group5"
author: "Mirre Dona (6156630), Merel Das (6600034), Lukas Stemerdink (6217265)"
date: "2023-11-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries
```{r}
library(ISLR) 
library(tidyverse) 
library(readr) # For data import
library(dplyr)
library(magrittr) # For pipes
library(mice) # For missing data
library(ggplot2) # For plotting
library(psych)
library(reshape2)

library(randomForest) # For random forest
library(rpart) # For decision tree
library(rpart.plot) # For plotting decision tree

```

# Import dataset
```{r}
sleepdata <- read.csv('data/Sleep_health_and_lifestyle_dataset.csv')
View(sleepdata)
```

# Description of the data
The Sleep Health and Lifestyle Dataset, here called sleepdata, consists of 400 rows and 13 columns. The dataset consists of sleep-related data. A lot of variables are presented, including gender, age, occupation, sleep duration, quality of sleep, physical activity levels, stress levels, BMI category, blood pressure, heart rate, daily steps, and, if it is the case, the sleep disorders. This dataset offers the opportunity to gain insights into whether sleep factors and lifestyle factors are related.

The following variables are included in the dataset:
- **Person ID**: An identifier for each individual in the dataset.
- **Gender**: [Male/Female] (stored as factor).
- **Age**: The age of the person in years (stored as integer).
- **Occupation**: The occupation or profession of the person (stored as factor).
- **Sleep Duration**: The number of hours the person sleeps per day (stored as numeric value).
- **Quality of Sleep**: [1-10] A subjective rating of the quality of sleep, ranging from 1 to 10 (stored as integer).
- **Physical Activity Level**: The number of minutes the person engages in physical activity daily (stored as integer of minutes/day).
- **Stress Level** [1-10]: A subjective rating of the stress level experienced by the person, ranging from 1 to 10 (stored as integer).
- **BMI Category**: The BMI category of the person (e.g., Underweight, Normal, Overweight, stored as factor).
- **Blood Pressure** (systolic/diastolic): The blood pressure measurement of the person, indicated as systolic pressure over diastolic pressure (stored as character).
- **Heart Rate** (bpm): The resting heart rate of the person in beats per minute (stored as integer).
- **Daily Steps**: The number of steps the person takes per day (stored as integer).
- **Sleep Disorder**: The presence or absence of a sleep disorder in the person (None, Insomnia, Sleep Apnea, stored as character).

To download the dataset, click [here](https://www.kaggle.com/code/jillanisofttech/sleep-health-and-lifestyle-predication-with-94-ac).

With this dataset, we aim to predict a person's sleep quality. We chose this response variable as we think it is valuable information for a person. Sleep quality is important for your health and can affect mental-health issues. It also influences how you feel during the day, which affects the activities you undertake and how well you do them.

# Data cleaning
Before we begin, the data should be cleaned for proper use.
## Missing data
```{r}
md.pattern(sleepdata)
```
There is no missing data in this dataset!

## Transform variable types
Let's convert the variables to the right type for exploration and prediction later on.
```{r}
# Check how many unique values of occupation, to see if it makes sense to convert to factor, or if there are too many unique values
unique(sleepdata$Occupation)
# The amount of values for the other chr variables were inspected in the R environment
```

```{r}
# Convert variables Gender, Occupation, BMI.Category, and Sleep.Disorder to a factor.
sleepdata %<>% 
  mutate(Gender   = as.factor(Gender),
         Occupation = as.factor(Occupation),
         BMI.Category = as.factor(BMI.Category),
         Sleep.Disorder = as.factor(Sleep.Disorder)) 
```
!!nog iets doen met blood pressure

## Select variables
For our analysis and prediction we do not need the person identifier of each case, so we remove this variable.
```{r}
sleepdata %<>% select(-Person.ID) # Remove Person.ID from sleepdata.
```

## Outlier removal
We checked for potential outliers based on the IQR criterion. For this, we used boxplot stats per numerical value, and looked how many outliers it produced. 

```{r}
# Check the outliers per variable:
boxplot.stats(sleepdata$Sleep.Duration)$out 
boxplot.stats(sleepdata$Quality.of.Sleep)$out
boxplot.stats(sleepdata$Physical.Activity.Level)$out
boxplot.stats(sleepdata$Stress.Level)$out
boxplot.stats(sleepdata$Heart.Rate)$out
boxplot.stats(sleepdata$Daily.Steps)$out

out <- boxplot.stats(sleepdata$Heart.Rate)$out # Save the outliers of Heart.Rate in variable out
out_ind <- which(sleepdata$Heart.Rate %in% c(out)) # Find the indices of the outliers in the dataset
sleepdata[out_ind, ] # Show the outliers in the dataset
```
As can be seen, only the Heart.Rate variable contains outliers; people with a much higher than average heart rate during sleep. When we look at the entries, we see that all these people have a sleep disorder, and that almost all of them are overweight or obese. Because of this, we conclude that these are "expected" outliers, and keep them in the dataset. 

# Exploratory data analysis

To explore the data, we take a look at different factors we have deemed as important: Quality of sleep, sleep duration, and BMI category

```{r}
# Create a boxplot of the sleep quality per sleep duration.
plot_sleepdata2 <- sleepdata %>% mutate(
  Quality.of.Sleep = as.factor(Quality.of.Sleep)
) %>% 
  ggplot(aes(x=Quality.of.Sleep, y=Sleep.Duration)) + 
  geom_boxplot(fill = "lightblue") + 
  theme_minimal() +
  labs(title="Sleep quality compared to sleep duration", x="Sleep quality", y="Sleep duration")
plot_sleepdata2

# Create a boxplot of the sleep quality per gender.
ggplot(sleepdata, aes(x = Gender, y = Quality.of.Sleep)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Sleep Quality by Gender", y = "Quality of Sleep")

# Summarize per Occupation the Sleep Duration
sleepdata %>% 
  group_by(Occupation) %>%
  summarise( 
    median = median(Sleep.Duration),
    min = min(Sleep.Duration),
    max = max(Sleep.Duration),
    mad = mad(Sleep.Duration) # Adding median absolute deviation 
  )

# Plot the average Quality of Sleep per BMI.Category
sleepdata %>% 
  ggplot(aes(x = BMI.Category, y = Quality.of.Sleep)) + 
  scale_x_discrete(limits = c("Normal", "Normal Weight", "Overweight", "Obese")) +
  geom_boxplot()

```
From this, it can be seen that it is not true that most people rated their sleep quality with 7. So other reasons behind this variety can be tested. However, it is clear that less people rated their sleep quality with 4 or 5, which could be a reason why there is less variety in sleep duration when the sleep quality is 4 or 5 (viewed in the boxplot).

# Prediction model
As described above, the response variable we chose to predict is quality of sleep. This response variable is a numerical variable with possible integer values 1 through 10. We considered converting this to a categorical variable 

## Feature selection
To create a well performing model to predict sleep quality, it is important to consider which features to use as predictors. To find which features are probably the most useful for predicting sleep quality, we do a short correlation analysis.

### Correlation
```{r}
# Store the data without the categorical variables in a new variable, cordata
cordata <- sleepdata %>% select(-Gender, -Occupation, -BMI.Category, -Blood.Pressure, -Sleep.Disorder)

# Create correlation matrix
corr_mat <- round(cor(cordata),2)

# Reduce the size of correlation matrix
melted_corr_mat <- melt(corr_mat)

# Plot the correlation heat map
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2, fill=value)) + geom_tile()
```


## Simple model selection
### Train, dev, test
```{r}
set.seed(123)

# Create a training set and a test set

train <- sample(1:nrow(sleepdata), 0.75*nrow(sleepdata)) # 75% of the rows for the training set.
train_data <- sleepdata[train,]
test_data <- sleepdata[-train,] # Use the other 25% of the rows for the test set.

```

```{r}
# Train a simple linear regression model on the training set of Quality of sleep
simple_model <- lm(Quality.of.Sleep ~ ., data = train_data)

# Make predictions on the test set
simple_predictions <- test_train %>% 
  mutate(Blood.Pressure = )
  predict(simple_model, newdata = test_data)
```

# R function to generate all formulas up to size n
# Erik-Jan van Kesteren
# October 2018

# Input : 
#  p      : number of variables 
#  x_vars : character vector of x vars
#  y_var  : character of y var

# Output: character vector of formulas
```{r}
generate_formulas <- function(p, x_vars, y_var) {
  # Input checking
  if (p %% 1 != 0)           stop("Input an integer n")
  if (p > length(x_vars))    stop("p should be smaller than number of vars")
  if (!is.character(x_vars)) stop("x_vars should be a character vector")
  if (!is.character(y_var))  stop("y_vars should be character type")
  
  # combn generates all combinations, apply turns them into formula strings
  apply(combn(x_vars, p), 2, function(vars) {
    paste0(y_var, " ~ ", paste(vars, collapse = " + "))
  })
}
```

### PCA (of wa anders)

## Simple model selection
### Train, dev, test
```{r}
#train, test, etc.
set.seed(123)
train <- sample(1:nrow(sleepdata), 0.75*nrow(sleepdata)) # 75% of the rows for the training set.
train_data <- sleepdata[train,]
test_data <- sleepdata[-train,] #use the other 25% of the rows for the test set.

#EDA
summary(train_data)

# Train a simple linear regression model
simple_model <- lm(Quality.of.Sleep ~ ., data = train_data)

# Make predictions on the test set
simple_predictions <- test_train %>% 
  mutate(Blood.Pressure = )
  predict(simple_model, newdata = test_data)
```

### Train model

# Classification tree
```{r}
tree_mod <- rpart(Quality.of.Sleep ~ ., data = sleepdata)
rpart.plot(tree_mod) #plot tree
```

# Random forest
```{r}
rf_mod <- randomForest(Quality.of.Sleep ~ ., data = sleepdata)
rf_mod
importance <- importance(rf_mod)

tibble(
  importance = c(importance), 
  variable = rownames(importance)
) %>% 
  ggplot(aes(x = variable, y = importance, fill = variable)) +
  geom_bar(stat = "identity")
```

# Boosting
```{r}
gbm_train <- train(Quality.of.Sleep ~ .,
                   data = sleepdata,
                   method = "gbm",
                   verbose = F, 
                   trControl = cvcontrol) #print bag_train, rf_train, gbm_train models to see accuracy
summary(gbm_train) #var importance plot
predictions <- predict(gbm_train)

```


### Performance evaluation

### Interpretation of model

## Complex model selection





