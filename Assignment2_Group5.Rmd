---
title: "A2_Group5"
author: "Mirre Dona (6156630), Merel Das (6600034), Lukas Stemerdink (6217265)"
date: "2023-11-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries
```{r}
library(ISLR) 
library(tidyverse) 
library(readr) # for data import
library(dplyr)
library(magrittr) # for pipes
library(mice) # for missing data
library(ggplot2) # for plotting
library(psych)
library(reshape2)

library(randomForest)
library(rpart)
library(rpart.plot)

```

# Import dataset
```{r}
sleepdata <- read.csv('data/Sleep_health_and_lifestyle_dataset.csv')
View(sleepdata)
```

# Description of the data
The Sleep Health and Lifestyle Dataset, here called sleepdata, consists of 400 rows and 13 columns. The dataset consists of sleep-related data. A lot of variables are presented, including gender, age, occupation, sleep duration, quality of sleep, physical activity levels, stress levels, BMI category, blood pressure, heart rate, daily steps, and, if it is the case, the sleep disorders. This dataset offers the opportunity to gain insights into whether sleep factors and lifestyle factors are related.

To download the dataset, click [here](https://www.kaggle.com/code/jillanisofttech/sleep-health-and-lifestyle-predication-with-94-ac).

With this dataset, we aim to predict a person's sleep quality. We chose this response variable as we think it is valuable information for a person. Sleep quality is important for your health and can affect mental-health issues. It also influences how you feel during the day, which affects the activities you undertake and how well you do them.

# Data cleaning
Before we begin, the data should be cleaned for proper use.
## Missing data
```{r}
md.pattern(sleepdata)
```
There is no missing data in this dataset!

## Transform variable types
Let's convert the variables to the right type for exploration and prediction later on. We chose to transform the sleep quality (a scale from 10 - 10) to a factor, as we have found in literature that for ratings with a narrow range, classification techniques often work better than regression. [1](https://aclanthology.org/W10-1205.pdf)[2](https://towardsdatascience.com/1-to-5-star-ratings-classification-or-regression-b0462708a4df)
```{r}
#check how many unique values of occupation, to see if it makes sense to convert to factor, or if there are too many unique values
unique(sleepdata$Occupation)
#The amount of values for the other chr variables were inspected in the R environment
```

```{r}
sleepdata %<>% 
  mutate(Gender   = as.factor(Gender),
         Occupation = as.factor(Occupation),
         BMI.Category = as.factor(BMI.Category),
         Sleep.Disorder = as.factor(Sleep.Disorder)) %>% 
  separate_wider_delim(cols = Blood.Pressure, delim = "/", names = c("Systolic", "Diastolic")) %>% 
  mutate(Blood.Reading = ifelse(
    test = Systolic >= 130 & Diastolic >= 90, yes = "High", no = ifelse(
      test = Systolic <= 90 & Diastolic <= 60, yes = "Low", no = "Ideal"
    )))
```
!!nog iets doen met blood pressure

## Select variables
For our analysis and prediction we do not need the person identifier of each case, so we remove this variable.
```{r}
sleepdata %<>% select(-Person.ID)
```

## Outlier removal
We checked for potential outliers based on the IQR criterion. For this, we used boxplot stats per numerical value, and looked how many outliers it produced. 

```{r}
boxplot.stats(sleepdata$Sleep.Duration)$out
boxplot.stats(sleepdata$Quality.of.Sleep)$out
boxplot.stats(sleepdata$Physical.Activity.Level)$out
boxplot.stats(sleepdata$Stress.Level)$out
boxplot.stats(sleepdata$Heart.Rate)$out
boxplot.stats(sleepdata$Daily.Steps)$out

out <- boxplot.stats(sleepdata$Heart.Rate)$out
out_ind <- which(sleepdata$Heart.Rate %in% c(out))
sleepdata[out_ind, ]
```
As can be seen, only the Heart.Rate variable contains outliers; people with a much higher than average heart rate during sleep. When we look at the entries, we see that all these people have a sleep disorder, and that almost all of them are overweight or obese. Because of this, we conclude that these are "expected" outliers, and keep them in the dataset. 

# Exploratory data analysis

To explore the data, we take a look at different factors we have deemed as important: Quality of sleep, sleep duration, and BMI category

```{r}
# create a boxplot of the sleep quality per sleep duration.
plot_sleepdata2 <- sleepdata %>% mutate(
  Quality.of.Sleep = as.factor(Quality.of.Sleep)
) %>% 
  ggplot(aes(x=Quality.of.Sleep, y=Sleep.Duration)) + 
  geom_boxplot(fill = "lightblue") + 
  theme_minimal() +
  labs(title="Sleep quality compared to sleep duration", x="Sleep quality", y="Sleep duration")
plot_sleepdata2
```

As can be seen in the box plot above, generally, the sleep quality increases as sleep duration increases. 
```{r}
ggplot(sleepdata, aes(x = Gender, y = Quality.of.Sleep)) +
  geom_boxplot(fill = "lightblue") +
  theme_minimal() +
  labs(title = "Sleep Quality by Gender", y = "Quality of Sleep")
```
Moreover, women seem to have a higher quality of sleep on average compared to men. 

```{r}
sleepdata %>% 
  group_by(Occupation) %>% 
  summarise( 
    median = median(Sleep.Duration),
    min = min(Sleep.Duration),
    max = max(Sleep.Duration),
    mad = mad(Sleep.Duration) # Adding median absolute deviation 
  )
```
Then, looking at the median, min, max, and median absolute deviation sleep duration per occupation, it can be seen that Sales Representatives sleep the least on average, followed by Scientist. Though the variation is not very strong per occupation, there is some variance. 

```{r}
sleepdata %>% 
  ggplot(aes(x = BMI.Category, y = Quality.of.Sleep)) + 
  scale_x_discrete(limits = c("Normal", "Normal Weight", "Overweight", "Obese")) +
  geom_boxplot(fill = "lightblue") + 
  theme_minimal() + 
  labs(title = "Sleep Quality per BMI category", x = "BMI category", y = "Quality of Sleep")
```
Lastly, looking at how the BMI category impacts the quality of sleep, people with lower weight seem to sleep better than heavier people. 

# Prediction model
As described above, the response variable we chose to predict is quality of sleep. This is a (transformed) categorical variable with possible values 1 through 10.

## Feature selection
To create a well performing model to predict sleep quality, it is important to consider which features to use as predictors. To find which features are probably the most useful for predicting sleep quality, we do a short correlation analysis.

### Correlation
```{r}
cordata <- sleepdata %>% 
  mutate(Gender   = as.numeric(Gender),
         Occupation = as.numeric(Occupation),
         BMI.Category = as.numeric(BMI.Category),
         Sleep.Disorder = as.numeric(Sleep.Disorder),
         Blood.Pressure = as.numeric(Blood.Pressure))


#create correlation matrix
corr_mat <- round(cor(cordata),2)

# reduce the size of correlation matrix
melted_corr_mat <- melt(corr_mat)

# plotting the correlation heatmap
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2, fill=value)) + geom_tile()+ theme(axis.text.x=element_text(angle=-15, hjust=-0.01))  + geom_text(aes(Var2, Var1, label = value), color = "white", size = 2)
```
The variable sleep duration is the most correlated with sleep quality. 


## Simple model selection
The classification models we considered for this prediction problem are ...

### Train, dev, test
First we split the data in training, validation, and test data
```{r}
#train, test, etc.
set.seed(123)
train <- sample(1:nrow(sleepdata), 0.75*nrow(sleepdata)) # 75% of the rows for the training set.
train_data <- sleepdata[train,]
test_data <- sleepdata[-train,] #use the other 25% of the rows for the test set.

```

### Train model

# Classification tree
```{r}
tree_mod <- rpart(Quality.of.Sleep ~ ., data = sleepdata)
rpart.plot(tree_mod) #plot tree
```

# Random forest
```{r}
rf_mod <- randomForest(Quality.of.Sleep ~ ., data = sleepdata)
rf_mod
importance <- importance(rf_mod)

tibble(
  importance = c(importance), 
  variable = rownames(importance)
) %>% 
  ggplot(aes(x = variable, y = importance, fill = variable)) +
  geom_bar(stat = "identity")
```

# Boosting
```{r}
gbm_train <- train(Quality.of.Sleep ~ .,
                   data = sleepdata,
                   method = "gbm",
                   verbose = F, 
                   trControl = cvcontrol) #print bag_train, rf_train, gbm_train models to see accuracy
summary(gbm_train) #var importance plot
predictions <- predict(gbm_train)

```


### Performance evaluation

### Interpretation of model

## Complex model selection





